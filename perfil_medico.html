<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Perfil m√©dico - SaludRural</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="assets/css/custom.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-sr navbar-dark">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="assets/img/logo.svg" alt="SaludRural" style="height:36px;margin-right:8px;">
      SaludRural
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="explorar_medicos.html">Explorar m√©dicos</a></li>
        <li class="nav-item"><a class="nav-link" href="diccionario.html">Diccionario</a></li>
        <li class="nav-item"><a class="nav-link" href="login.html">Iniciar sesi√≥n</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container section">
  <!-- Loading -->
  <div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Perfil del m√©dico -->
  <div id="profileCard" class="card card-sr d-none">
    <div class="profile-header">
      <div class="container d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <img id="p_foto" src="" class="medico-photo" alt="">
          <div>
            <h4 id="p_name" class="mb-1"></h4>
            <small id="p_esp"></small>
          </div>
        </div>
        <div id="actions"></div>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h5 class="mb-3">Sobre el m√©dico</h5>
          <p id="p_desc"></p>
          
          <div class="mb-3">
            <strong>Calificaci√≥n:</strong> <span id="p_rating"></span>
          </div>
          
          <div id="p_experiencia" class="mb-3"></div>
          
          <h5 class="mt-4 mb-3">Opiniones de pacientes</h5>
          <div id="opiniones"></div>
        </div>
        <div class="col-md-4">
          <h5 class="mb-3">Disponibilidad</h5>
          <div id="loadingAgenda" class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status"></div>
          </div>
          <div id="agenda" class="mb-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div id="errorCard" class="alert alert-danger d-none">
    <h5>Error</h5>
    <p id="errorMsg"></p>
    <a href="explorar_medicos.html" class="btn btn-primary">Volver a m√©dicos</a>
  </div>
</div>

<!-- Modal Cuestionario -->
<div class="modal fade" id="modalQuestion" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cuestionario previo a la cita</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Motivo de la consulta *</label>
          <input class="form-control" id="motivo" required placeholder="Ej: Control m√©dico, dolor de cabeza...">
        </div>
        <div class="mb-3">
          <label class="form-label">S√≠ntomas (opcional)</label>
          <textarea class="form-control" id="sintomas" rows="3" placeholder="Describa sus s√≠ntomas"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Preferencia de consulta</label>
          <select id="pref" class="form-select">
            <option value="video">Videollamada</option>
            <option value="audio">Solo audio</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-sr" id="confirmSchedule">Continuar y seleccionar horario</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Seleccionar Horario -->
<div class="modal fade" id="modalHorario" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar horario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Seleccione el d√≠a y hora de su preferencia:</p>
        <div id="horSlots" class="d-flex gap-2 flex-wrap"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-sr" id="finalize">Confirmar cita</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer-sr mt-5">
  <div class="container">
    <div>¬© 2025 SaludRural ‚Äì Telemedicina para zonas rurales</div>
  </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/api.js"></script>

<script>
// Variables globales
let medicoActual = null;
let disponibilidad = [];
let horarioSeleccionado = null;
let modalQuestion, modalHorario;

// Obtener ID del m√©dico de la URL
const params = new URLSearchParams(window.location.search);
const medicoId = parseInt(params.get('med'));

// Usuario actual
const currentUser = API.getCurrentUser();

// Cargar perfil del m√©dico
async function cargarPerfil() {
  const loadingEl = document.getElementById('loading');
  const profileEl = document.getElementById('profileCard');
  const errorEl = document.getElementById('errorCard');
  const errorMsg = document.getElementById('errorMsg');

  if (!medicoId) {
    loadingEl.classList.add('d-none');
    errorMsg.textContent = 'ID de m√©dico no v√°lido';
    errorEl.classList.remove('d-none');
    return;
  }

  try {
    medicoActual = await API.Medicos.getById(medicoId);
    
    if (!medicoActual) {
      throw new Error('M√©dico no encontrado');
    }
    
    // Mostrar informaci√≥n del m√©dico
    document.getElementById('p_foto').src = medicoActual.foto;
    document.getElementById('p_foto').alt = medicoActual.nombre;
    document.getElementById('p_name').textContent = `${medicoActual.nombre} ${medicoActual.apellidos || ''}`;
    document.getElementById('p_esp').textContent = medicoActual.especialidad;
    document.getElementById('p_desc').textContent = medicoActual.descripcion;
    document.getElementById('p_rating').innerHTML = `${medicoActual.rating} ‚≠ê`;
    
    if (medicoActual.experiencia) {
      document.getElementById('p_experiencia').innerHTML = `<strong>Experiencia:</strong> ${medicoActual.experiencia}`;
    }
    
    // Cargar opiniones (placeholder)
    const opinionesEl = document.getElementById('opiniones');
    if (medicoActual.opiniones && medicoActual.opiniones.length > 0) {
      medicoActual.opiniones.forEach(op => {
        opinionesEl.innerHTML += `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between mb-1">
              <strong>${op.user}</strong>
              <span>${op.score} ‚≠ê</span>
            </div>
            <p class="mb-0 small">${op.comment}</p>
          </div>
        `;
      });
    } else {
      opinionesEl.innerHTML = '<p class="text-muted small">A√∫n no hay opiniones</p>';
    }
    
    // Mostrar bot√≥n de agendar solo si es paciente
    const actionsEl = document.getElementById('actions');
    if (currentUser && currentUser.rol === 'Paciente') {
      actionsEl.innerHTML = '<button id="btnAgendar" class="btn btn-light">üìÖ Agendar cita</button>';
      document.getElementById('btnAgendar').addEventListener('click', iniciarAgendamiento);
    } else {
      actionsEl.innerHTML = '<div class="small text-white-50">Inicia sesi√≥n como paciente para agendar cita</div>';
    }
    
    // Cargar disponibilidad
    cargarDisponibilidad();
    
    loadingEl.classList.add('d-none');
    profileEl.classList.remove('d-none');
    
  } catch (error) {
    console.error('Error al cargar perfil:', error);
    loadingEl.classList.add('d-none');
    errorMsg.textContent = error.message || 'Error al cargar el perfil del m√©dico';
    errorEl.classList.remove('d-none');
  }
}

// Cargar disponibilidad del m√©dico
async function cargarDisponibilidad() {
  const loadingEl = document.getElementById('loadingAgenda');
  const agendaEl = document.getElementById('agenda');
  
  try {
    disponibilidad = await API.Agenda.getDisponibilidad(medicoId);
    
    loadingEl.classList.add('d-none');
    
    if (disponibilidad.length === 0) {
      agendaEl.innerHTML = '<p class="text-muted small">No hay horarios disponibles</p>';
    } else {
      // Agrupar por fecha
      const porFecha = {};
      disponibilidad.filter(d => d.disponible).forEach(d => {
        if (!porFecha[d.fecha]) {
          porFecha[d.fecha] = [];
        }
        porFecha[d.fecha].push(d.hora);
      });
      
      agendaEl.innerHTML = '';
      Object.keys(porFecha).forEach(fecha => {
        const div = document.createElement('div');
        div.className = 'mb-2';
        div.innerHTML = `
          <strong class="d-block mb-1">${fecha}</strong>
          <div class="small text-muted">${porFecha[fecha].join(', ')}</div>
        `;
        agendaEl.appendChild(div);
      });
    }
  } catch (error) {
    console.error('Error al cargar disponibilidad:', error);
    loadingEl.classList.add('d-none');
    agendaEl.innerHTML = '<p class="text-danger small">Error al cargar horarios</p>';
  }
}

// Iniciar proceso de agendamiento
function iniciarAgendamiento() {
  modalQuestion = new bootstrap.Modal(document.getElementById('modalQuestion'));
  modalQuestion.show();
}

// Confirmar cuestionario y mostrar horarios
document.getElementById('confirmSchedule').addEventListener('click', () => {
  const motivo = document.getElementById('motivo').value.trim();
  
  if (!motivo) {
    alert('Por favor ingrese el motivo de la consulta');
    return;
  }
  
  // Mostrar horarios disponibles
  const slotsEl = document.getElementById('horSlots');
  slotsEl.innerHTML = '';
  
  const horariosDisponibles = disponibilidad.filter(d => d.disponible);
  
  if (horariosDisponibles.length === 0) {
    slotsEl.innerHTML = '<p class="text-muted">No hay horarios disponibles en este momento</p>';
  } else {
    horariosDisponibles.forEach(slot => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-primary';
      btn.textContent = `${slot.fecha} ${slot.hora}`;
      btn.dataset.fecha = slot.fecha;
      btn.dataset.hora = slot.hora;
      
      btn.addEventListener('click', function() {
        // Quitar selecci√≥n previa
        document.querySelectorAll('#horSlots button').forEach(b => {
          b.classList.remove('active', 'btn-primary');
          b.classList.add('btn-outline-primary');
        });
        
        // Marcar como seleccionado
        this.classList.remove('btn-outline-primary');
        this.classList.add('active', 'btn-primary');
        
        horarioSeleccionado = {
          fecha: this.dataset.fecha,
          hora: this.dataset.hora
        };
      });
      
      slotsEl.appendChild(btn);
    });
  }
  
  // Mostrar modal de horarios
  modalHorario = new bootstrap.Modal(document.getElementById('modalHorario'));
  modalHorario.show();
});

// Finalizar y confirmar cita
document.getElementById('finalize').addEventListener('click', async () => {
  if (!horarioSeleccionado) {
    alert('Por favor seleccione un horario');
    return;
  }
  
  const motivo = document.getElementById('motivo').value.trim();
  const sintomas = document.getElementById('sintomas').value.trim();
  const preferencia = document.getElementById('pref').value;
  
  // Datos de la cita
  const citaData = {
    id_paciente: currentUser.id_usuario,
    id_medico: medicoActual.id,
    medico_nombre: `${medicoActual.nombre} ${medicoActual.apellidos || ''}`,
    fecha: horarioSeleccionado.fecha,
    hora: horarioSeleccionado.hora,
    fecha_hora: `${horarioSeleccionado.fecha} ${horarioSeleccionado.hora}`,
    motivo: motivo,
    sintomas: sintomas,
    preferencia: preferencia,
    estado: 'Programada'
  };
  
  try {
    // Crear la cita
    await API.Citas.create(citaData);
    
    // Cerrar modales
    modalHorario.hide();
    modalQuestion.hide();
    
    // Mostrar √©xito
    alert(`¬°Cita confirmada exitosamente!\n\nFecha: ${horarioSeleccionado.fecha}\nHora: ${horarioSeleccionado.hora}\nM√©dico: ${medicoActual.nombre}`);
    
    // Redirigir al dashboard
    setTimeout(() => {
      window.location.href = '/paciente/dashboard.html';
    }, 1000);
    
  } catch (error) {
    console.error('Error al crear cita:', error);
    alert('Error al confirmar la cita: ' + error.message);
  }
});

// Inicializar
document.addEventListener('DOMContentLoaded', cargarPerfil);
</script>

</body>
</html>