<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Paciente - Dashboard - SaludRural</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/custom.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-sr navbar-dark">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="../index.html">
      <img src="../assets/img/logo.svg" alt="SaludRural" style="height:36px;margin-right:8px;">
      SaludRural
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="../explorar_medicos.html">Explorar m√©dicos</a></li>
        <li class="nav-item"><a class="nav-link" href="../diccionario.html">Diccionario</a></li>
        <li class="nav-item">
          <span class="nav-link" id="userInfo"></span>
        </li>
        <li class="nav-item">
          <button class="btn btn-sm btn-outline-light" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container section">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 id="welcomeMsg">Panel del paciente</h2>
      <p class="text-muted mb-0" id="userEmail"></p>
    </div>
  </div>

  <div class="row">
    <!-- Columna izquierda -->
    <div class="col-md-6">
      <!-- Mis pr√≥ximas citas -->
      <div class="card card-sr p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Mis pr√≥ximas citas</h5>
          <a href="../explorar_medicos.html" class="btn btn-sm btn-sr">Agendar nueva</a>
        </div>
        <div id="loadingCitas" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <ul id="misCitas" class="list-group d-none"></ul>
        <div id="noCitas" class="alert alert-info d-none">
          No tienes citas programadas. <a href="../explorar_medicos.html">Agenda tu primera cita</a>
        </div>
      </div>

      <!-- Historial cl√≠nico -->
      <div class="card card-sr p-3">
        <h5 class="mb-3">Historial cl√≠nico</h5>
        <div id="loadingHistorial" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <div id="historial" class="d-none"></div>
        <div id="noHistorial" class="alert alert-info d-none">
          A√∫n no tienes registros en tu historial cl√≠nico.
        </div>
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="col-md-6">
      <!-- Estad√≠sticas r√°pidas -->
      <div class="row mb-3">
        <div class="col-6">
          <div class="card card-sr p-3 text-center">
            <h3 class="mb-1" id="totalCitas">0</h3>
            <small class="text-muted">Citas programadas</small>
          </div>
        </div>
        <div class="col-6">
          <div class="card card-sr p-3 text-center">
            <h3 class="mb-1" id="totalConsultas">0</h3>
            <small class="text-muted">Consultas realizadas</small>
          </div>
        </div>
      </div>

      <!-- Explorar m√©dicos -->
      <div class="card card-sr p-3">
        <h5 class="mb-3">M√©dicos disponibles</h5>
        <div id="loadingMedicos" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
        <div id="miniMed" class="d-none"></div>
        <a href="../explorar_medicos.html" class="btn btn-sr mt-3 w-100">Ver todos los m√©dicos</a>
      </div>
    </div>
  </div>
</div>

<footer class="footer-sr mt-5">
  <div class="container">
    <div>¬© 2025 SaludRural ‚Äì Telemedicina para zonas rurales</div>
  </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../assets/js/api.js"></script>

<script>
// Verificar autenticaci√≥n y rol
if (!API.requireAuth() || !API.requireRole('Paciente')) {
  // requireAuth y requireRole ya redirigen si falla
}

// Obtener usuario actual
const currentUser = API.getCurrentUser();

// Mostrar informaci√≥n del usuario
document.getElementById('welcomeMsg').textContent = `Bienvenido, ${currentUser.nombre}`;
document.getElementById('userEmail').textContent = currentUser.correo;
document.getElementById('userInfo').textContent = `${currentUser.nombre} ${currentUser.apellidos || ''}`;

// Funci√≥n para cerrar sesi√≥n
function cerrarSesion() {
  if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
    API.logout();
  }
}

// Cargar citas del paciente
async function cargarCitas() {
  const loadingEl = document.getElementById('loadingCitas');
  const listEl = document.getElementById('misCitas');
  const noDataEl = document.getElementById('noCitas');

  try {
    const citas = await API.Citas.getByPaciente(currentUser.id_usuario);
    
    loadingEl.classList.add('d-none');
    
    if (citas.length === 0) {
      noDataEl.classList.remove('d-none');
      document.getElementById('totalCitas').textContent = '0';
    } else {
      listEl.classList.remove('d-none');
      listEl.innerHTML = '';
      
      // Filtrar solo citas activas (no canceladas)
      const citasActivas = citas.filter(c => c.estado !== 'Cancelada');
      document.getElementById('totalCitas').textContent = citasActivas.length;
      
      citasActivas.forEach((cita, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        const fechaHora = cita.fecha_hora || `${cita.fecha} ${cita.hora}`;
        
        li.innerHTML = `
          <div>
            <strong>${cita.medico_nombre || 'M√©dico'}</strong>
            <br>
            <small class="small-muted">
              üìÖ ${fechaHora}
            </small>
            <br>
            <span class="badge bg-success">${cita.estado}</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-danger" onclick="cancelarCita(${cita.id})">
              Cancelar
            </button>
          </div>
        `;
        listEl.appendChild(li);
      });
    }
  } catch (error) {
    console.error('Error al cargar citas:', error);
    loadingEl.classList.add('d-none');
    listEl.innerHTML = '<li class="list-group-item text-danger">Error al cargar citas</li>';
    listEl.classList.remove('d-none');
  }
}

// Cancelar cita
async function cancelarCita(citaId) {
  if (!confirm('¬øEst√°s seguro de que quieres cancelar esta cita?')) {
    return;
  }

  try {
    await API.Citas.cancel(citaId);
    alert('Cita cancelada exitosamente');
    cargarCitas(); // Recargar lista
  } catch (error) {
    alert('Error al cancelar la cita: ' + error.message);
  }
}

// Cargar historial cl√≠nico
async function cargarHistorial() {
  const loadingEl = document.getElementById('loadingHistorial');
  const historialEl = document.getElementById('historial');
  const noDataEl = document.getElementById('noHistorial');

  try {
    const registros = await API.Historia.getByPaciente(currentUser.id_usuario);
    
    loadingEl.classList.add('d-none');
    
    if (registros.length === 0) {
      noDataEl.classList.remove('d-none');
      document.getElementById('totalConsultas').textContent = '0';
    } else {
      historialEl.classList.remove('d-none');
      historialEl.innerHTML = '';
      document.getElementById('totalConsultas').textContent = registros.length;
      
      // Ordenar por fecha (m√°s reciente primero)
      registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      
      // Mostrar solo los √∫ltimos 5
      registros.slice(0, 5).forEach(reg => {
        const div = document.createElement('div');
        div.className = 'border rounded p-3 mb-2';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>${reg.fecha}</strong>
            <small class="text-muted">${reg.medico}</small>
          </div>
          ${reg.diagnostico ? `<p class="mb-1"><strong>Diagn√≥stico:</strong> ${reg.diagnostico}</p>` : ''}
          ${reg.tratamiento ? `<p class="mb-1"><strong>Tratamiento:</strong> ${reg.tratamiento}</p>` : ''}
          ${reg.notas ? `<p class="mb-0"><strong>Notas:</strong> ${reg.notas}</p>` : ''}
        `;
        historialEl.appendChild(div);
      });
      
      if (registros.length > 5) {
        const moreLink = document.createElement('div');
        moreLink.className = 'text-center mt-2';
        moreLink.innerHTML = '<a href="#" class="small">Ver historial completo</a>';
        historialEl.appendChild(moreLink);
      }
    }
  } catch (error) {
    console.error('Error al cargar historial:', error);
    loadingEl.classList.add('d-none');
    historialEl.innerHTML = '<div class="text-danger">Error al cargar historial</div>';
    historialEl.classList.remove('d-none');
  }
}

// Cargar m√©dicos disponibles
async function cargarMedicos() {
  const loadingEl = document.getElementById('loadingMedicos');
  const medEl = document.getElementById('miniMed');

  try {
    const medicos = await API.Medicos.getAll();
    
    loadingEl.classList.add('d-none');
    medEl.classList.remove('d-none');
    medEl.innerHTML = '';
    
    // Mostrar solo los primeros 3
    medicos.slice(0, 3).forEach(medico => {
      const div = document.createElement('div');
      div.className = 'border rounded p-2 mb-2';
      div.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <img src="${medico.foto}" class="medico-photo" alt="${medico.nombre}">
          <div class="flex-grow-1">
            <strong>${medico.nombre} ${medico.apellidos || ''}</strong><br>
            <small class="small-muted">${medico.especialidad} ‚Ä¢ ${medico.rating} ‚≠ê</small>
          </div>
          <a class="btn btn-sm btn-sr" href="../perfil_medico.html?med=${medico.id}">
            Ver perfil
          </a>
        </div>
      `;
      medEl.appendChild(div);
    });
  } catch (error) {
    console.error('Error al cargar m√©dicos:', error);
    loadingEl.classList.add('d-none');
    medEl.innerHTML = '<div class="text-danger">Error al cargar m√©dicos</div>';
    medEl.classList.remove('d-none');
  }
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', () => {
  cargarCitas();
  cargarHistorial();
  cargarMedicos();
});
</script>

</body>
</html>