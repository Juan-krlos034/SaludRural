<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Explorar m√©dicos - SaludRural</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/custom.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-sr navbar-dark">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="assets/img/logo.svg" alt="SaludRural" style="height:36px;margin-right:8px;">
      SaludRural
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link active" href="explorar_medicos.html">Explorar m√©dicos</a></li>
        <li class="nav-item"><a class="nav-link" href="diccionario.html">Diccionario</a></li>
        <li class="nav-item" id="navAuth">
          <a class="nav-link" href="login.html">Iniciar sesi√≥n</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container section">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h2>Explorar m√©dicos</h2>
      <p class="text-muted mb-0">Encuentra profesionales de la salud especializados</p>
    </div>
    <div class="d-flex gap-2 w-100 w-md-auto">
      <input id="search" class="form-control search-input" placeholder="Buscar por nombre o especialidad">
      <select id="filtroEspecialidad" class="form-select" style="max-width:200px;">
        <option value="">Todas las especialidades</option>
      </select>
      <select id="orden" class="form-select" style="max-width:160px;">
        <option value="mejor">Mejor calificados</option>
        <option value="nombre">Por nombre</option>
      </select>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="text-muted mt-2">Cargando m√©dicos...</p>
  </div>

  <!-- Resultados -->
  <div id="result" class="row g-3 d-none"></div>

  <!-- Sin resultados -->
  <div id="noResults" class="alert alert-info d-none">
    No se encontraron m√©dicos con los criterios de b√∫squeda.
  </div>
</div>

<footer class="footer-sr mt-5">
  <div class="container">
    <div>¬© 2025 SaludRural ‚Äì Telemedicina para zonas rurales</div>
  </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/api.js"></script>

<script>
// Variables globales
let todosMedicos = [];
let medicosActuales = [];

// Verificar si hay usuario autenticado
const currentUser = API.getCurrentUser();
if (currentUser) {
  const navAuth = document.getElementById('navAuth');
  navAuth.innerHTML = `
    <span class="nav-link">üë§ ${currentUser.nombre}</span>
  `;
}

// Cargar m√©dicos
async function cargarMedicos() {
  const loadingEl = document.getElementById('loading');
  const resultEl = document.getElementById('result');
  const noResultsEl = document.getElementById('noResults');

  try {
    todosMedicos = await API.Medicos.getAll();
    medicosActuales = [...todosMedicos];
    
    // Extraer especialidades √∫nicas para el filtro
    const especialidades = [...new Set(todosMedicos.map(m => m.especialidad))];
    const selectEsp = document.getElementById('filtroEspecialidad');
    especialidades.forEach(esp => {
      const option = document.createElement('option');
      option.value = esp;
      option.textContent = esp;
      selectEsp.appendChild(option);
    });
    
    loadingEl.classList.add('d-none');
    renderMedicos(medicosActuales);
  } catch (error) {
    console.error('Error al cargar m√©dicos:', error);
    loadingEl.classList.add('d-none');
    noResultsEl.textContent = 'Error al cargar m√©dicos. Por favor, intenta de nuevo.';
    noResultsEl.classList.remove('d-none');
  }
}

// Renderizar m√©dicos
function renderMedicos(medicos) {
  const resultEl = document.getElementById('result');
  const noResultsEl = document.getElementById('noResults');
  
  resultEl.innerHTML = '';
  
  if (medicos.length === 0) {
    resultEl.classList.add('d-none');
    noResultsEl.classList.remove('d-none');
    return;
  }
  
  noResultsEl.classList.add('d-none');
  resultEl.classList.remove('d-none');
  
  medicos.forEach(medico => {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    
    col.innerHTML = `
      <div class="card card-sr h-100">
        <div class="card-body">
          <div class="d-flex gap-3 align-items-start mb-3">
            <img src="${medico.foto}" class="medico-photo" alt="${medico.nombre}">
            <div class="flex-grow-1">
              <h5 class="mb-1">${medico.nombre} ${medico.apellidos || ''}</h5>
              <small class="small-muted d-block mb-1">${medico.especialidad}</small>
              <div class="mb-2">
                <span class="badge bg-warning text-dark">${medico.rating} ‚≠ê</span>
              </div>
            </div>
          </div>
          <p class="small mb-3">${medico.descripcion}</p>
          ${medico.experiencia ? `<p class="small text-muted mb-2">üìã ${medico.experiencia}</p>` : ''}
          <div class="d-grid">
            <a href="perfil_medico.html?med=${medico.id}" class="btn btn-sr">
              Ver perfil y agendar
            </a>
          </div>
        </div>
      </div>
    `;
    
    resultEl.appendChild(col);
  });
}

// Filtrar y ordenar m√©dicos
function aplicarFiltros() {
  const busqueda = document.getElementById('search').value.toLowerCase();
  const especialidad = document.getElementById('filtroEspecialidad').value;
  const orden = document.getElementById('orden').value;
  
  // Filtrar
  let filtrados = [...todosMedicos];
  
  // Filtro de b√∫squeda
  if (busqueda) {
    filtrados = filtrados.filter(m => 
      m.nombre.toLowerCase().includes(busqueda) ||
      (m.apellidos && m.apellidos.toLowerCase().includes(busqueda)) ||
      m.especialidad.toLowerCase().includes(busqueda) ||
      m.descripcion.toLowerCase().includes(busqueda)
    );
  }
  
  // Filtro de especialidad
  if (especialidad) {
    filtrados = filtrados.filter(m => m.especialidad === especialidad);
  }
  
  // Ordenar
  if (orden === 'mejor') {
    filtrados.sort((a, b) => b.rating - a.rating);
  } else if (orden === 'nombre') {
    filtrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
  }
  
  medicosActuales = filtrados;
  renderMedicos(filtrados);
}

// Event listeners
document.getElementById('search').addEventListener('input', aplicarFiltros);
document.getElementById('filtroEspecialidad').addEventListener('change', aplicarFiltros);
document.getElementById('orden').addEventListener('change', aplicarFiltros);

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', cargarMedicos);
</script>

</body>
</html>